name: CI pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  check-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up node and pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run lint
        run: pnpm lint

  tsc:
    runs-on: ubuntu-latest
    needs: check-lint
    steps:
      - uses: actions/checkout@v2
      - name: Set up node and pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run tsc
        run: pnpm -r tsc

  test:
    runs-on: ubuntu-latest
    needs: [check-lint, tsc]
    steps:
      - uses: actions/checkout@v2
      - name: Set up node and pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run tests
        run: pnpm -r test

  detect-changes:
    runs-on: ubuntu-latest
    needs: [check-lint, tsc, test]
    outputs:
      services: ${{ steps.changes.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect changed services
        id: changes
        run: |
          # Get all services from services/ directory
          ALL_SERVICES=$(ls -d services/*/ 2>/dev/null | sed 's|services/||' | sed 's|/||' | jq -R -s -c 'split("\n")[:-1]')
          
          # Determine the diff command based on event type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, compare against base branch
            DIFF_CMD="git diff --name-only origin/${{ github.base_ref }}...HEAD"
          else
            # For pushes, compare against previous commit
            # Handle first push where before might be empty
            if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              DIFF_CMD="git diff --name-only --diff-filter=A HEAD"
            else
              DIFF_CMD="git diff --name-only ${{ github.event.before }} ${{ github.sha }}"
            fi
          fi
          
          # Check for root-level changes that affect all services
          ROOT_CHANGED=false
          if $DIFF_CMD | grep -qE "^(package\.json|pnpm-workspace\.yaml|pnpm-lock\.yaml)"; then
            ROOT_CHANGED=true
          fi
          
          # Build array of changed services
          CHANGED_SERVICES="[]"
          
          if [ "$ROOT_CHANGED" = "true" ]; then
            # If root changed, include all services
            CHANGED_SERVICES="$ALL_SERVICES"
            echo "Root files changed, building all services"
          else
            # Check each service individually
            for service in $(echo "$ALL_SERVICES" | jq -r '.[]'); do
              if $DIFF_CMD | grep -q "^services/$service/"; then
                CHANGED_SERVICES=$(echo "$CHANGED_SERVICES" | jq -c ". + [\"$service\"]")
                echo "Service changed: $service"
              fi
            done
          fi
          
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "Changed services: $CHANGED_SERVICES"

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up node and pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} build